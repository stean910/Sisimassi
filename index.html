<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–°–∞–ø—ë—Ä ‚Äî –æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --panel-2: #0b1220;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --accent: #22c55e;
        --danger: #ef4444;
        --warn: #f59e0b;
        --cell-size: 34px;
        --cell-gap: 4px;
        --cell-shadow: inset 0 1px 0 rgba(255,255,255,0.04), inset 0 -1px 0 rgba(0,0,0,0.5);
        --radius: 10px;
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        color: var(--text);
        background: radial-gradient(1200px 600px at 10% -10%, #1b2a52, transparent 50%),
                    radial-gradient(1000px 500px at 110% -10%, #1a2c3a, transparent 40%),
                    var(--bg);
      }

      .app {
        max-width: 1100px;
        margin: 24px auto;
        padding: 16px;
      }

      .card {
        background: linear-gradient(180deg, rgba(255,255,255,0.04), transparent 60%), var(--panel);
        border: 1px solid rgba(148, 163, 184, 0.15);
        border-radius: var(--radius);
        box-shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.05);
        overflow: hidden;
      }

      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 16px 16px 8px;
      }

      h1 {
        font-size: 18px;
        margin: 0;
        letter-spacing: 0.3px;
        color: #e9eefb;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
      }

      .row {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .panel {
        background: var(--panel-2);
        border: 1px solid rgba(148, 163, 184, 0.15);
        border-radius: 10px;
        padding: 8px 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      label { font-size: 13px; color: var(--muted); }
      select, input[type="number"] {
        background: #0b1220;
        color: var(--text);
        border: 1px solid rgba(148,163,184,0.25);
        border-radius: 8px;
        padding: 6px 8px;
        outline: none;
      }

      .btn {
        background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.01));
        color: var(--text);
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 10px;
        padding: 8px 12px;
        cursor: pointer;
        transition: transform .05s ease, background .2s ease, border-color .2s ease;
        user-select: none;
      }
      .btn:hover { border-color: rgba(255,255,255,0.35); }
      .btn:active { transform: translateY(1px); }
      .btn.primary { border-color: rgba(34,197,94,0.5); box-shadow: 0 0 0 1px rgba(34,197,94,0.15) inset; }
      .btn.toggle.active { border-color: rgba(245,158,11,0.6); box-shadow: 0 0 0 1px rgba(245,158,11,0.18) inset; }

      .stats {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .stat {
        background: #0b1220;
        border: 1px solid rgba(148, 163, 184, 0.18);
        border-radius: 10px;
        padding: 8px 10px;
        min-width: 84px;
        text-align: center;
        font-variant-numeric: tabular-nums;
      }
      .stat .label { font-size: 11px; color: var(--muted); }
      .stat .value { font-size: 18px; }

      .board-wrap { padding: 16px; }
      .board {
        display: grid;
        grid-template-columns: repeat(var(--cols), var(--cell-size));
        grid-auto-rows: var(--cell-size);
        gap: var(--cell-gap);
        justify-content: start;
        touch-action: manipulation;
        user-select: none;
      }

      .cell {
        width: var(--cell-size);
        height: var(--cell-size);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        font-weight: 700;
        font-size: 16px;
        border: 1px solid rgba(148,163,184,0.2);
        background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
        box-shadow: var(--cell-shadow);
        cursor: pointer;
      }
      .cell.covered { background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.01)); }
      .cell.revealed { cursor: default; background: #0a1222; border-color: rgba(148,163,184,0.12); }
      .cell.mine.revealed { background: radial-gradient(400px 200px at 50% -10%, rgba(239,68,68,0.2), transparent 60%), #1a0f12; }
      .cell.flagged { background: linear-gradient(180deg, rgba(245,158,11,0.15), rgba(245,158,11,0.05)); border-color: rgba(245,158,11,0.4); }
      .cell:hover:not(.revealed) { filter: brightness(1.08); }

      .num-1 { color: #59a9ff; }
      .num-2 { color: #34d399; }
      .num-3 { color: #fb7185; }
      .num-4 { color: #60a5fa; }
      .num-5 { color: #f59e0b; }
      .num-6 { color: #22d3ee; }
      .num-7 { color: #e879f9; }
      .num-8 { color: #a3a3a3; }

      .footer {
        padding: 8px 16px 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: var(--muted);
        font-size: 12px;
      }

      .msg {
        display: none;
        margin-left: 10px;
        padding: 6px 10px;
        border-radius: 8px;
        border: 1px solid rgba(148,163,184,0.25);
        background: #0b1220;
      }
      .msg.show { display: inline-flex; align-items: center; gap: 6px; }
      .msg.win { border-color: rgba(34,197,94,0.45); color: #86efac; }
      .msg.lose { border-color: rgba(239,68,68,0.45); color: #fca5a5; }

      .custom-fields { display: none; gap: 6px; }
      .custom-fields.show { display: inline-flex; }

      @media (max-width: 700px) {
        :root { --cell-size: 32px; --cell-gap: 3px; }
        header { flex-direction: column; align-items: stretch; }
        .controls { justify-content: space-between; }
        .stats { justify-content: space-between; }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="card">
        <header>
          <h1>–°–∞–ø—ë—Ä</h1>
          <div class="controls">
            <div class="panel">
              <label for="difficulty">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
              <select id="difficulty">
                <option value="beginner">–ù–æ–≤–∏—á–æ–∫ 9√ó9 (10)</option>
                <option value="intermediate">–õ—é–±–∏—Ç–µ–ª—å 16√ó16 (40)</option>
                <option value="expert">–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª 30√ó16 (99)</option>
                <option value="custom">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è‚Ä¶</option>
              </select>
              <div id="customFields" class="custom-fields">
                <label>–®–∏—Ä–∏–Ω–∞ <input id="colsInput" type="number" min="5" max="60" value="10" /></label>
                <label>–í—ã—Å–æ—Ç–∞ <input id="rowsInput" type="number" min="5" max="40" value="10" /></label>
                <label>–ú–∏–Ω—ã <input id="minesInput" type="number" min="1" max="500" value="10" /></label>
              </div>
            </div>
            <button id="flagModeBtn" class="btn toggle" title="–†–µ–∂–∏–º —Ñ–ª–∞–≥–∞ (–¥–ª—è —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤)">üö© –†–µ–∂–∏–º —Ñ–ª–∞–≥–∞</button>
            <button id="newGameBtn" class="btn primary">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
          </div>
          <div class="stats">
            <div class="stat"><div class="label">–ú–ò–ù –û–°–¢.</div><div id="minesLeft" class="value">0</div></div>
            <div class="stat"><div class="label">–í–†–ï–ú–Ø</div><div id="timer" class="value">000</div></div>
            <div id="message" class="msg"></div>
          </div>
        </header>
        <div class="board-wrap">
          <div id="board" class="board" style="--cols: 9;"></div>
        </div>
        <div class="footer">
          <div>–õ–ö–ú ‚Äî –æ—Ç–∫—Ä—ã—Ç—å ¬∑ –ü–ö–ú ‚Äî —Ñ–ª–∞–≥ ¬∑ –î–æ–ª–≥–æ–µ –∫–∞—Å–∞–Ω–∏–µ ‚Äî —Ñ–ª–∞–≥</div>
          <div>–ü–µ—Ä–≤—ã–π –∫–ª–∏–∫ –≤—Å–µ–≥–¥–∞ –±–µ–∑–æ–ø–∞—Å–µ–Ω</div>
        </div>
      </div>
    </div>

    <script>
      const boardEl = document.getElementById('board');
      const difficultyEl = document.getElementById('difficulty');
      const newGameBtn = document.getElementById('newGameBtn');
      const minesLeftEl = document.getElementById('minesLeft');
      const timerEl = document.getElementById('timer');
      const messageEl = document.getElementById('message');
      const flagModeBtn = document.getElementById('flagModeBtn');
      const customFieldsEl = document.getElementById('customFields');
      const colsInput = document.getElementById('colsInput');
      const rowsInput = document.getElementById('rowsInput');
      const minesInput = document.getElementById('minesInput');

      let numRows = 9;
      let numCols = 9;
      let numMines = 10;
      let board = [];
      let firstClick = true;
      let gameOver = false;
      let revealedCount = 0;
      let minesLeft = 0;
      let flagMode = false;
      let timerInterval = null;
      let elapsed = 0;

      function formatTimer(n) {
        return String(n).padStart(3, '0');
      }

      function stopTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }

      function resetTimer() {
        stopTimer();
        elapsed = 0;
        timerEl.textContent = formatTimer(0);
      }

      function startTimer() {
        if (timerInterval) return;
        timerInterval = setInterval(() => {
          elapsed = Math.min(elapsed + 1, 999);
          timerEl.textContent = formatTimer(elapsed);
        }, 1000);
      }

      function setMessage(text, type) {
        messageEl.textContent = text || '';
        messageEl.className = 'msg' + (text ? ' show' : '');
        if (type === 'win') messageEl.classList.add('win');
        if (type === 'lose') messageEl.classList.add('lose');
      }

      function makeEmptyBoard() {
        board = new Array(numRows).fill(null).map((_, r) => new Array(numCols).fill(null).map((_, c) => ({
          row: r,
          col: c,
          isMine: false,
          isRevealed: false,
          isFlagged: false,
          adjacent: 0,
          el: null,
        })));
      }

      function inBounds(r, c) { return r >= 0 && r < numRows && c >= 0 && c < numCols; }

      function forEachNeighbor(r, c, fn) {
        for (let dr = -1; dr <= 1; dr++) {
          for (let dc = -1; dc <= 1; dc++) {
            if (dr === 0 && dc === 0) continue;
            const nr = r + dr, nc = c + dc;
            if (inBounds(nr, nc)) fn(board[nr][nc]);
          }
        }
      }

      function placeMines(excludeSet) {
        let placed = 0;
        const total = numRows * numCols;
        const indices = Array.from({ length: total }, (_, i) => i);
        // shuffle
        for (let i = indices.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [indices[i], indices[j]] = [indices[j], indices[i]];
        }
        for (const idx of indices) {
          if (placed >= numMines) break;
          const r = Math.floor(idx / numCols);
          const c = idx % numCols;
          const key = r + ':' + c;
          if (excludeSet && excludeSet.has(key)) continue;
          if (!board[r][c].isMine) {
            board[r][c].isMine = true;
            placed++;
          }
        }
      }

      function computeAdjacents() {
        for (let r = 0; r < numRows; r++) {
          for (let c = 0; c < numCols; c++) {
            let count = 0;
            forEachNeighbor(r, c, (n) => { if (n.isMine) count++; });
            board[r][c].adjacent = count;
          }
        }
      }

      function updateMinesLeftDisplay() { minesLeftEl.textContent = String(minesLeft).padStart(2, '0'); }

      function endGame(win) {
        gameOver = true;
        stopTimer();
        if (!win) revealAllMines();
        setMessage(win ? '–ü–æ–±–µ–¥–∞! üéâ' : '–ü–æ–¥–æ—Ä–≤–∞–ª–∏—Å—å üí•', win ? 'win' : 'lose');
      }

      function revealAllMines() {
        for (let r = 0; r < numRows; r++) {
          for (let c = 0; c < numCols; c++) {
            const cell = board[r][c];
            if (cell.isMine) {
              cell.el.classList.add('mine');
              if (!cell.isRevealed) showCell(cell, true);
              cell.el.textContent = 'üí£';
            }
          }
        }
      }

      function showCell(cell, force) {
        if (cell.isRevealed && !force) return;
        cell.isRevealed = true;
        cell.el.classList.remove('covered');
        cell.el.classList.add('revealed');
        cell.el.textContent = '';
        if (cell.isMine) {
          cell.el.classList.add('mine');
          cell.el.textContent = 'üí£';
          return;
        }
        if (cell.adjacent > 0) {
          cell.el.textContent = String(cell.adjacent);
          cell.el.classList.add('num-' + cell.adjacent);
        }
      }

      function floodReveal(startCell) {
        const queue = [startCell];
        const seen = new Set();
        while (queue.length) {
          const cell = queue.shift();
          const key = cell.row + ':' + cell.col;
          if (seen.has(key)) continue;
          seen.add(key);
          if (!cell.isRevealed) {
            showCell(cell);
            revealedCount++;
          }
          if (cell.adjacent === 0) {
            forEachNeighbor(cell.row, cell.col, (n) => {
              if (!n.isRevealed && !n.isMine && !n.isFlagged) queue.push(n);
            });
          }
        }
      }

      function tryWin() {
        const totalSafe = numRows * numCols - numMines;
        if (revealedCount >= totalSafe) endGame(true);
      }

      function handleReveal(cell) {
        if (cell.isRevealed || cell.isFlagged || gameOver) return;
        if (firstClick) {
          const exclude = new Set();
          exclude.add(cell.row + ':' + cell.col);
          forEachNeighbor(cell.row, cell.col, (n) => exclude.add(n.row + ':' + n.col));
          placeMines(exclude);
          computeAdjacents();
          firstClick = false;
          startTimer();
        }
        if (cell.isMine) {
          showCell(cell);
          endGame(false);
          return;
        }
        if (cell.adjacent === 0) floodReveal(cell); else { showCell(cell); revealedCount++; }
        tryWin();
      }

      function toggleFlag(cell) {
        if (cell.isRevealed || gameOver) return;
        cell.isFlagged = !cell.isFlagged;
        if (cell.isFlagged) { cell.el.classList.add('flagged'); cell.el.textContent = 'üö©'; minesLeft = Math.max(0, minesLeft - 1); }
        else { cell.el.classList.remove('flagged'); cell.el.textContent = ''; minesLeft = Math.min(numMines, minesLeft + 1); }
        updateMinesLeftDisplay();
      }

      function buildUI() {
        boardEl.style.setProperty('--cols', String(numCols));
        boardEl.innerHTML = '';
        for (let r = 0; r < numRows; r++) {
          for (let c = 0; c < numCols; c++) {
            const cell = board[r][c];
            const el = document.createElement('div');
            el.className = 'cell covered';
            el.dataset.row = String(r);
            el.dataset.col = String(c);
            cell.el = el;

            let pressTimer = null;
            const clearPressTimer = () => { if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; } };

            el.addEventListener('click', (e) => {
              e.preventDefault();
              if (flagMode) return toggleFlag(cell);
              handleReveal(cell);
            });
            el.addEventListener('contextmenu', (e) => { e.preventDefault(); toggleFlag(cell); });

            el.addEventListener('touchstart', (e) => {
              clearPressTimer();
              pressTimer = setTimeout(() => { toggleFlag(cell); pressTimer = null; }, 420);
            }, { passive: true });
            el.addEventListener('touchend', (e) => {
              if (pressTimer) { clearPressTimer(); if (!flagMode) handleReveal(cell); }
            });
            el.addEventListener('touchcancel', clearPressTimer);

            boardEl.appendChild(el);
          }
        }
      }

      function applyDifficultyFromUI() {
        const diff = difficultyEl.value;
        if (diff === 'beginner') { numRows = 9; numCols = 9; numMines = 10; customFieldsEl.classList.remove('show'); }
        else if (diff === 'intermediate') { numRows = 16; numCols = 16; numMines = 40; customFieldsEl.classList.remove('show'); }
        else if (diff === 'expert') { numRows = 16; numCols = 30; numMines = 99; customFieldsEl.classList.remove('show'); }
        else {
          customFieldsEl.classList.add('show');
          const cols = clamp(parseInt(colsInput.value || '10', 10), 5, 60);
          const rows = clamp(parseInt(rowsInput.value || '10', 10), 5, 40);
          const maxMines = Math.max(1, rows * cols - 1);
          const mines = clamp(parseInt(minesInput.value || '10', 10), 1, Math.min(500, maxMines));
          numRows = rows; numCols = cols; numMines = mines;
          minesInput.max = String(Math.min(500, maxMines));
        }
      }

      function clamp(n, min, max) { return Math.max(min, Math.min(max, isFinite(n) ? n : min)); }

      function newGame() {
        applyDifficultyFromUI();
        firstClick = true;
        gameOver = false;
        revealedCount = 0;
        minesLeft = numMines;
        updateMinesLeftDisplay();
        setMessage('');
        resetTimer();
        makeEmptyBoard();
        buildUI();
      }

      // Wire up controls
      difficultyEl.addEventListener('change', newGame);
      colsInput.addEventListener('change', newGame);
      rowsInput.addEventListener('change', newGame);
      minesInput.addEventListener('change', newGame);
      newGameBtn.addEventListener('click', newGame);
      flagModeBtn.addEventListener('click', () => {
        flagMode = !flagMode;
        flagModeBtn.classList.toggle('active', flagMode);
      });

      // Init
      newGame();
    </script>
  </body>
</html>
