<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Симулятор парусной гонки</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; background: #eef; }
  #inputContainer { display: flex; gap: 20px; margin: 20px; }
  textarea { width: 400px; height: 250px; font-family: monospace; font-size: 14px; padding: 10px; }
  #canvasContainer { position: relative; }
  canvas { border: 1px solid #333; background: #a0d8f7; }
  #infoPanel { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px; font-size: 14px; }
  #playBtn { margin: 10px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
</style>
</head>
<body>

<h2>Парусная гонка — визуализация и анализ</h2>

<div id="inputContainer">
  <div>
    <h3>Погодные условия (DeepSeek)</h3>
    <textarea id="weatherInput" spellcheck="false">[
  {"time": 0, "windDirection": 185, "windSpeed": 7},
  {"time": 1, "windDirection": 182, "windSpeed": 6},
  {"time": 2, "windDirection": 178, "windSpeed": 6}
]</textarea>
  </div>
  <div>
    <h3>Действия гонщика (10 вариантов)</h3>
    <textarea id="racerInput" spellcheck="false">[
  [{"time":0,"turn":0,"sail":1,"position":0}],
  [{"time":0,"turn":10,"sail":1,"position":1}],
  [{"time":0,"turn":-10,"sail":1,"position":-1}],
  [{"time":0,"turn":5,"sail":1,"position":0}],
  [{"time":0,"turn":-5,"sail":1,"position":1}],
  [{"time":0,"turn":15,"sail":1,"position":-1}],
  [{"time":0,"turn":-15,"sail":1,"position":0}],
  [{"time":0,"turn":0,"sail":0.8,"position":1}],
  [{"time":0,"turn":0,"sail":1.2,"position":-1}],
  [{"time":0,"turn":5,"sail":0.9,"position":0}]
]</textarea>
  </div>
</div>

<button id="playBtn">Play</button>

<div id="canvasContainer" style="position: relative;">
  <canvas id="raceCanvas" width="800" height="500"></canvas>
  <div id="infoPanel">
    <div id="windInfo"></div>
    <div id="heelInfo"></div>
    <div id="timeInfo"></div>
  </div>
</div>

<script>
const canvas = document.getElementById('raceCanvas');
const ctx = canvas.getContext('2d');

const playBtn = document.getElementById('playBtn');
const weatherInput = document.getElementById('weatherInput');
const racerInput = document.getElementById('racerInput');

const windInfo = document.getElementById('windInfo');
const heelInfo = document.getElementById('heelInfo');
const timeInfo = document.getElementById('timeInfo');

const DISTANCE = 700; // длина дистанции в пикселях (пример)
const BOAT_SPEED_BASE = 5; // базовая скорость

// Функция для конвертации градусов в радианы
function degToRad(deg) {
  return deg * Math.PI / 180;
}

// Класс яхты для упрощенной физики
class Yacht {
  constructor(actions) {
    this.x = 50; // стартовая позиция
    this.y = canvas.height / 2;
    this.heading = 0; // курс, градусы (0 - вправо)
    this.speed = 0;
    this.heel = 0; // крен
    this.actions = actions; // массив действий гонщика
    this.currentStep = 0;
    this.finished = false;
    this.time = 0;
  }
  
  update(wind) {
    if(this.finished) return;
    const action = this.actions[this.currentStep] || {turn:0, sail:1};
    
    // Поворот яхты с учетом действия гонщика
    this.heading += action.turn * 0.1; // умножаем на коэффициент плавности
    
    // Крен зависит от поворота и ветра (упрощенно)
    this.heel = Math.min(30, Math.abs(action.turn) * wind.windSpeed);
    
    // Скорость зависит от силы ветра и настройки паруса
    this.speed = BOAT_SPEED_BASE * wind.windSpeed * action.sail * Math.cos(degToRad(Math.abs(this.heading - wind.windDirection)));
    if(this.speed < 0) this.speed = 0;
    
    // Двигаем яхту по курсу
    const rad = degToRad(this.heading);
    this.x += this.speed * Math.cos(rad);
    this.y += this.speed * Math.sin(rad);
    
    // Считаем время
    this.time += 1;
    
    // Переход к следующему действию через некоторое время
    if(this.time % 10 === 0 && this.currentStep < this.actions.length - 1) {
      this.currentStep++;
    }
    
    // Проверка финиша
    if(this.x >= DISTANCE) {
      this.finished = true;
    }
  }
  
  draw(color) {
    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.rotate(degToRad(this.heading));
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.moveTo(20, 0);
    ctx.lineTo(-10, -7);
    ctx.lineTo(-10, 7);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }
}

// Рисуем ветер
function drawWind(wind) {
  const centerX = 50;
  const centerY = 50;
  const length = 40;
  ctx.save();
  ctx.strokeStyle = 'rgba(0,0,255,0.5)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(centerX, centerY);
  const rad = degToRad(wind.windDirection);
  ctx.lineTo(centerX + length * Math.cos(rad), centerY + length * Math.sin(rad));
  ctx.stroke();
  ctx.restore();
  
  windInfo.innerText = `Ветер: ${wind.windSpeed.toFixed(1)} узл, направление: ${wind.windDirection.toFixed(0)}°`;
}

// Главная функция симуляции
function simulate(weather, racers) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  // Отрисовка дистанции
  ctx.strokeStyle = '#444';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(50, canvas.height / 2);
  ctx.lineTo(DISTANCE, canvas.height / 2);
  ctx.stroke();
  
  // Отрисовка яхт
  const colors = ['red','green','blue','orange','purple','cyan','magenta','lime','brown','pink'];
  
  // Временно берем первый момент погоды
  const currentWind = weather[0];
  drawWind(currentWind);
  
  racers.forEach((racer, i) => {
    racer.update(currentWind);
    racer.draw(colors[i]);
  });
  
  // Информация
  heelInfo.innerText = `Крен (примерно): ${racers.map(r => r.heel.toFixed(1)).join(', ')}`;
  timeInfo.innerText = `Время (шаги): ${racers.map(r => r.time).join(', ')}`;
}

// Обработка нажатия кнопки Play
playBtn.onclick = () => {
  let weatherData, racersData;
  try {
    weatherData = JSON.parse(weatherInput.value);
    racersData = JSON.parse(racerInput.value);
    if(racersData.length !== 10) alert('Нужно ровно 10 вариантов действий для гонщиков!');
  } catch(e) {
    alert('Ошибка в формате JSON!');
    return;
  }
  
  // Создаем яхты
  const yachts = racersData.map(actions => new Yacht(actions));
  
  // Запускаем анимацию
  let step = 0;
  function animate() {
    if(step >= 200) return; // ограничение по времени
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = '#444';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(50, canvas.height / 2);
    ctx.lineTo(DISTANCE, canvas.height / 2);
    ctx.stroke();
    
    // Возьмем ветровые условия по времени (модуляция)
    const windIndex = Math.min(step, weatherData.length -1);
    const currentWind = weatherData[windIndex];
    drawWind(currentWind);
    
    // Обновляем яхты
    yachts.forEach((yacht,i) => {
      yacht.update(currentWind);
      yacht.draw(['red','green','blue','orange','purple','cyan','magenta','lime','brown','pink'][i]);
    });
    
    // Обновляем инфо
    heelInfo.innerText = `Крен: ${yachts.map(y => y.heel.toFixed(1)).join(', ')}`;
    timeInfo.innerText = `Время: ${step}`;
    
    step++;
    requestAnimationFrame(animate);
  }
  
  animate();
};
</script>

</body>
</html>
